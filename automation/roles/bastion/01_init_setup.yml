---
- name: Configure and Harden Bastion (Squid + Security Only)
  hosts: bastion
  become: true
  gather_facts: true

  vars:
    ssh_port: 22

    # -- Squid Configuration --
    squid_listen_ip: "10.0.1.2"
    squid_listen_port: 3128
    vpn_network_cidr: "10.0.1.0/24"

    # Safe ports (Standard HTTP/SSL)
    squid_connect_ports:
      - 443      # HTTPS
      - 80       # HTTP

  pre_tasks:
    - name: PREFLIGHT | Install common prerequisites
      ansible.builtin.apt:
        name:
          - ufw                 # Firewall
          - fail2ban            # Anti-Bruteforce
          - unattended-upgrades # Security patches
          - net-tools           # Debugging (netstat, etc)
        state: present
        update_cache: true
        cache_valid_time: 3600

  tasks:
    # =================================================================
    # FIREWALL HARDENING (UFW)
    # =================================================================
    - name: FIREWALL | Configure UFW policies
      community.general.ufw:
        state: enabled
        policy: "{{ item.policy }}"
        direction: "{{ item.direction }}"
      loop:
        - { direction: "incoming", policy: "deny" }
        - { direction: "outgoing", policy: "allow" }

    - name: FIREWALL | Allow essential incoming traffic
      community.general.ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto | default('any') }}"
        src: "{{ item.src | default('any') }}"
        comment: "{{ item.comment }}"
      loop:
        # SSH (Be careful: limiting src IP is better if you have a static IP)
        - port: "{{ ssh_port }}"
          proto: "tcp"
          comment: "Allow SSH access"
        # SQUID (Only allow from the private network!)
        - port: "{{ squid_listen_port }}"
          src: "{{ vpn_network_cidr }}"
          comment: "Allow Squid from Private Network"
      notify: Reload UFW Handler

    # =================================================================
    # SQUID PROXY SETUP
    # =================================================================
    - name: SQUID | Install Squid package
      ansible.builtin.apt:
        name: squid
        state: present
        update_cache: true

    - name: SQUID | Deploy Squid configuration
      ansible.builtin.template:
        src: templates/squid.conf.j2
        dest: /etc/squid/squid.conf
        owner: root
        group: root
        mode: '0644'
      notify: Restart Squid Handler

    - name: SQUID | Ensure Squid service is running
      ansible.builtin.systemd:
        name: squid
        state: started
        enabled: true

  # =================================================================
  # HANDLERS
  # =================================================================
  handlers:
    - name: Restart Squid Handler
      ansible.builtin.systemd:
        name: squid
        state: restarted

    - name: Reload UFW Handler
      community.general.ufw:
        state: reloaded
