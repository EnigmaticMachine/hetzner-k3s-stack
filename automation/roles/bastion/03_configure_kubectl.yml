---
- name: Configure kubectl on Bastion for K3s Cluster Access
  hosts: bastion
  become: no
  gather_facts: yes

  vars:
    # --- Configuration ---
    # IP address of your internal, high-availability K3s Load Balancer.
    k3s_lb_ip: "10.0.1.2"

    # --- Dynamic Variables (No need to change these) ---
    # Dynamically gets the primary K3s server from your inventory to fetch the initial config.
    k3s_primary_server: "{{ groups['k3s_first_server'][0] }}"

    # Defines the standard kubeconfig directory and path for the user running the playbook.
    kube_dir: "{{ lookup('env', 'HOME') }}/.kube"
    kube_config_path: "{{ lookup('env', 'HOME') }}/.kube/config"


    # Defines the predictable local path where Ansible's 'fetch' module will store the file.
    # It's constructed from your inventory location and the source server's name.
    fetched_kubeconfig_path: "{{ hostvars[inventory_hostname]['inventory_dir'] }}/fetched/k3s.yaml"

  tasks:
    - name: Ensure prerequisite | Verify kubectl is installed on the bastion
      ansible.builtin.command: kubectl version --client
      register: kubectl_check
      changed_when: false
      failed_when: kubectl_check.rc != 0
      run_once: true

    - name: Controller | Create a temporary local directory for the fetched kubeconfig
      ansible.builtin.file:
        path: "{{ hostvars[inventory_hostname]['inventory_dir'] }}/fetched"
        state: directory
        mode: '0700'
      delegate_to: localhost
      run_once: true

    - name: K3s Server | Fetch the kubeconfig file from the primary K3s server
      ansible.builtin.fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ hostvars[inventory_hostname]['inventory_dir'] }}/fetched/"
        flat: yes
      delegate_to: "{{ k3s_primary_server }}"

    - name: Bastion | Create .kube directory for the management user
      ansible.builtin.file:
        path: "{{ kube_dir }}"
        state: directory
        mode: '0755'

    - name: Controller | Modify fetched kubeconfig to point to the K3s Load Balancer
      ansible.builtin.replace:
        path: "{{ fetched_kubeconfig_path }}"
        regexp: 'https://127\.0\.0\.1:6443'
        replace: "https://{{ k3s_lb_ip }}:6443"
      delegate_to: localhost
      no_log: true

    - name: Bastion | Copy the modified and secured kubeconfig to the user's .kube directory
      ansible.builtin.copy:
        src: "{{ fetched_kubeconfig_path }}"
        dest: "{{ kube_config_path }}"
        mode: '0600' # BEST PRACTICE: Secure the kubeconfig file to be read/write only by the owner.
      no_log: true

    - name: VERIFY | Check kubectl connectivity to the cluster via the Load Balancer
      ansible.builtin.command: kubectl get nodes
      register: kubectl_get_nodes
      changed_when: false

    - name: VERIFY | Display cluster nodes as confirmation
      ansible.builtin.debug:
        msg: "{{ kubectl_get_nodes.stdout_lines }}"
