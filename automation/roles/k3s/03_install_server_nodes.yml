---
# ============================================================================
# PLAY 1: INITIALIZE FIRST SERVER (LEADER)
# ============================================================================
- name: Install K3s on the First Server Node
  hosts: k3s_first_server
  become: true

  vars_files:
    - "../../vars.yml"

  pre_tasks:
    - name: Generate/Retrieve Cluster Token
      ansible.builtin.set_fact:
        k3s_token: "{{ lookup('password', 'credentials/k3s_token.txt length=32 chars=ascii_letters,digits') }}"
      delegate_to: localhost
      run_once: true

    - name: Set K3s Flags
      ansible.builtin.set_fact:
        k3s_server_common_flags: >-
          --tls-san {{ lb_public_ip }}
          --tls-san {{ lb_private_ip }}
          --disable servicelb
          --disable-cloud-controller
        k3s_first_server_flags: "--cluster-init"

  tasks:
    - name: Install required packages
      ansible.builtin.apt:
        name: [curl, ca-certificates, apt-transport-https, software-properties-common]
        state: present
        update_cache: yes

    - name: Check if K3s is already installed
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    - name: Install K3s Server (Cluster Init)
      ansible.builtin.shell: |
        set -euo pipefail
        curl -sfL https://get.k3s.io | timeout {{ k3s_install_timeout }} sh -s - server \
          {{ k3s_server_common_flags }} \
          {{ k3s_first_server_flags }}
      args:
        executable: /bin/bash
      environment:
        http_proxy: "{{ proxy_url }}"
        https_proxy: "{{ proxy_url }}"
        no_proxy: "{{ no_proxy_list | join(',') }}"
        K3S_TOKEN: "{{ k3s_token }}"
        INSTALL_K3S_VERSION: "{{ k3s_version }}"
      when: not k3s_binary.stat.exists

    - name: Wait for K3s service
      ansible.builtin.systemd:
        name: k3s
        state: started
        enabled: true
      register: k3s_service_result
      until: k3s_service_result is succeeded
      retries: 5
      delay: 10

    - name: Verify Node is Ready
      ansible.builtin.command: k3s kubectl get nodes
      register: k3s_nodes
      changed_when: false
      until: 'ansible_hostname in k3s_nodes.stdout and "Ready" in k3s_nodes.stdout'
      retries: 15
      delay: 10


# ============================================================================
# PLAY 2: JOIN OTHER SERVERS (HA FOLLOWERS)
# ============================================================================
- name: Install K3s on Other Server Nodes
  hosts: k3s_other_servers
  become: true

  vars_files:
    - "../../vars.yml"

  vars:
    # This safely looks up the IP. If 'ansible_host' is missing, it falls back to the hostname.
    leader_name: "{{ groups['k3s_first_server'][0] }}"
    first_server_ip: "{{ hostvars[leader_name].get('ansible_host', leader_name) }}"

  pre_tasks:
    - name: Retrieve Cluster Token
      ansible.builtin.set_fact:
        k3s_token: "{{ lookup('file', 'credentials/k3s_token.txt') }}"
      delegate_to: localhost

    - name: Set K3s Flags
      ansible.builtin.set_fact:
        k3s_server_common_flags: >-
          --tls-san {{ lb_public_ip }}
          --tls-san {{ lb_private_ip }}
          --disable servicelb
          --disable-cloud-controller
        k3s_other_server_flags: "--server https://{{ first_server_ip }}:6443"

  tasks:
    - name: Ensure K3s manifests directory exists
      ansible.builtin.file:
        path: /var/lib/rancher/k3s/server/manifests
        state: directory
        mode: '0755'
        recurse: yes

    - name: Create Traefik config override (Trust LB)
      ansible.builtin.copy:
        dest: /var/lib/rancher/k3s/server/manifests/traefik-config.yaml
        content: |
          apiVersion: helm.cattle.io/v1
          kind: HelmChartConfig
          metadata:
            name: traefik
            namespace: kube-system
          spec:
            valuesContent: |-
              entryPoints:
                web:
                  forwardedHeaders:
                    trustedIPs:
                      - "{{ private_network_cidr }}"
        owner: root
        group: root
        mode: '0644'

    - name: Install required packages
      ansible.builtin.apt:
        name: [curl, ca-certificates, apt-transport-https]
        state: present
        update_cache: yes

    - name: Check if K3s is already installed
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    # We delegate to bastion to avoid local routing issues
    - name: Wait for First Server to be Ready
      ansible.builtin.wait_for:
        host: "{{ first_server_ip }}"
        port: 6443
        timeout: 300
        state: started
      delegate_to: bastion
      become: false

    - name: Install K3s Server (Join Cluster)
      ansible.builtin.shell: |
        set -euo pipefail
        curl -sfL https://get.k3s.io | timeout {{ k3s_install_timeout }} sh -s - server \
          {{ k3s_server_common_flags }} \
          {{ k3s_other_server_flags }}
      args:
        executable: /bin/bash
      environment:
        http_proxy: "{{ proxy_url }}"
        https_proxy: "{{ proxy_url }}"
        no_proxy: "{{ no_proxy_list | join(',') }}"
        K3S_TOKEN: "{{ k3s_token }}"
        INSTALL_K3S_VERSION: "{{ k3s_version }}"
      when: not k3s_binary.stat.exists

    - name: Wait for K3s service
      ansible.builtin.systemd:
        name: k3s
        state: started
        enabled: true
      register: k3s_service_result
      until: k3s_service_result is succeeded
      retries: 5
      delay: 10

    - name: Verify Node Joined
      ansible.builtin.command: k3s kubectl get nodes
      register: k3s_nodes
      changed_when: false
      until: 'ansible_hostname in k3s_nodes.stdout and "Ready" in k3s_nodes.stdout'
      retries: 15
      delay: 10

# ============================================================================
# PLAY 3: FINAL HEALTH CHECK
# ============================================================================
- name: Verify K3s Cluster Health
  hosts: k3s_first_server
  become: true
  tasks:
    - name: Get Cluster Nodes
      ansible.builtin.command: k3s kubectl get nodes -o wide
      register: cluster_nodes
      changed_when: false

    - name: Display Cluster Status
      ansible.builtin.debug:
        msg: "{{ cluster_nodes.stdout_lines }}"
