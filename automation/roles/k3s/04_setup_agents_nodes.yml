---
- name: Install K3s on Agent Nodes and Join Cluster
  hosts: k3s-agents
  become: true
  vars_files:
    - ../vars.yml
  vars:
    # Set timeouts for installation and service startup
    k3s_install_timeout: 300
    k3s_service_start_timeout: 120
    k3s_version: "{{ k3s_version | default('v1.32.3+k3s1') }}"

  pre_tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - k3s_api_server_url is defined
          - k3s_api_server_url | length > 0
          - k3s_token is defined
          - k3s_token | length > 0
        fail_msg: "Required variables (k3s_api_server_url, k3s_token) are not defined."

  tasks:
    - name: Update apt package cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      register: apt_update_result
      retries: 3
      delay: 5
      until: apt_update_result is succeeded

    - name: Upgrade all packages
      ansible.builtin.apt:
        upgrade: dist
        autoremove: true
      register: apt_upgrade_result
      retries: 2
      delay: 10
      until: apt_upgrade_result is succeeded

    # - name: Check if reboot is required
    #   ansible.builtin.stat:
    #     path: /var/run/reboot-required
    #   register: reboot_required_file

    # - name: Reboot the server if a reboot is required
    #   ansible.builtin.reboot:
    #     msg: "Rebooting host due to package upgrades."
    #     reboot_timeout: 600
    #   when: reboot_required_file.stat.exists

    - name: Check if K3s is already installed
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    - name: Check K3s agent service status
      ansible.builtin.systemd:
        name: k3s-agent
      register: k3s_agent_service_status
      ignore_errors: true
      when: k3s_binary.stat.exists

    - name: Install K3s Agent (join cluster)
      ansible.builtin.shell: |
        set -euo pipefail
        curl -sfL https://get.k3s.io | timeout {{ k3s_install_timeout }} sh -s -
      args:
        executable: /bin/bash
      # FIX: Added environment block with proxy settings and install vars.
      # This is the crucial fix to ensure curl can download the installer.
      environment:
        http_proxy: "http://10.0.1.1:3128"
        https_proxy: "http://10.0.1.1:3128"
        no_proxy: "localhost,127.0.0.1,::1,10.0.1.0/24,192.168.0.0/16,.cluster.local,{{ inventory_hostname }}"
        INSTALL_K3S_VERSION: "{{ k3s_version }}"
        K3S_URL: "{{ k3s_api_server_url }}"
        K3S_TOKEN: "{{ k3s_token }}"
      register: k3s_install_result
      # This condition is more robust: it runs if k3s isn't installed OR if it's installed but the service is not active.
      when: not k3s_binary.stat.exists or (k3s_agent_service_status is defined and k3s_agent_service_status.status.ActiveState != "active")
      changed_when: k3s_install_result.rc == 0
      failed_when: k3s_install_result.rc != 0

    - name: Wait for K3s agent service to be active
      ansible.builtin.systemd:
        name: k3s-agent
        state: started
        enabled: true
      register: k3s_service_result
      retries: 5
      delay: "{{ k3s_service_start_timeout // 5 }}"
      until: k3s_service_result is succeeded

  post_tasks:
    - name: Display agent installation status
      ansible.builtin.debug:
        msg: "K3s agent installation on {{ ansible_hostname }} completed."


# This final play is a best practice to verify the outcome from the master node.
- name: Verify Agent Nodes have Joined the Cluster
  hosts: k3s_first_server # Run this from the master
  become: true

  tasks:
    - name: Check node status for all agents that were just configured
      # This command checks if the node is present and has a "Ready" status.
      # We loop through all hosts in the 'k3s-agents' group that were part of the play.
      ansible.builtin.command: "k3s kubectl get node {{ item }}"
      register: node_status
      changed_when: false
      retries: 10 # Give agents time to register
      delay: 15
      until: node_status is succeeded and 'Ready' in node_status.stdout
      loop: "{{ ansible_play_batch }}" # 'ansible_play_batch' contains hosts from the previous play
      loop_control:
        loop_var: item

    - name: Final validation success message
      ansible.builtin.debug:
        msg: "All agent nodes have successfully joined the cluster and are in a 'Ready' state."
